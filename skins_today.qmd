---
title: "Today's NBA Skins Picks"
format:
  html:
    self-contained: true
    grid:
      body-width: 1200px
    css: |
      table {
        width: auto !important;
        margin-left: auto;
        margin-right: auto;
      }
---

```{r setup}
#| echo: false
#| message: false
#| warning: false
# Load all required packages for the whole document
if (!require("pacman")) install.packages("pacman")
pacman::p_load(rvest, httr, dplyr, tidyr, stringr, lubridate, tibble, knitr, kableExtra, readr)

# Create history directory - use relative path that works in both local and GitHub Actions
history_dir <- "skins_history"
if (!dir.exists(history_dir)) {
  dir.create(history_dir, recursive = TRUE)
}
```

```{r timestamp}
#| echo: false
#| results: 'asis'
ts <- format(Sys.time(), "%A, %B %d, %Y at %I:%M %p %Z", tz = "America/Chicago")
cat(paste0("<p style='font-size:14px; color:#555;'><strong>Last updated:</strong> ", ts, "</p>"))
```

This page shows the expected skins for today's NBA games, based on live odds.

```{r expected_skins_data}
#| echo: false
#| message: false
#| warning: false

# --- Part 1: Scrape Expected Odds ---
url <- paste0("https://www.sportsline.com/nba/odds/money-line/",
              "?t=", format(Sys.time(), "%Y%m%d%H%M%S"))
googlebot_ua <- "Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)"

page_session <- rvest::session(url, httr::user_agent(googlebot_ua))
html_content <- rvest::read_html(page_session)
game_data_raw <- html_content %>% html_element("table") %>% html_table()

# Extract correct columns and clean team names
game_data <- data.frame(
  Matchup_raw = game_data_raw[[1]],
  consensus = game_data_raw[[3]],
  stringsAsFactors = FALSE
) %>%
  mutate(
    # Remove the record (e.g., "2-1") from team names
    Matchup = str_remove(Matchup_raw, "\\d+-\\d+$")
  )

# --- Part 2: Define Skins Picks ---
draft_data <- tribble(
  ~Team, ~Matchup_Key, ~abbr, ~skins_pick, ~player,
  "Utah Jazz", "Jazz|Utah", "UTA", "L", "Eristeo",
  "Oklahoma City Thunder", "Thunder|Oklahoma", "OKC", "W", "Matt",
  "Washington Wizards", "Wizards|Washington", "WAS", "L", "Brian",
  "Brooklyn Nets", "Nets|Brooklyn", "BKN", "L", "Adam",
  "Cleveland Cavaliers", "Cavaliers|Cleveland", "CLE", "W", "Thomas",
  "Charlotte Hornets", "Hornets|Charlotte", "CHA", "L", "Brian",
  "Denver Nuggets", "Nuggets|Denver", "DEN", "W", "Thomas",
  "New York Knicks", "Knicks|New York", "NYK", "W", "Adam",
  "Houston Rockets", "Rockets|Houston", "HOU", "W", "Kenneth",
  "Phoenix Suns", "Suns|Phoenix", "PHX", "L", "Eristeo",
  "New Orleans Pelicans", "Pelicans|New Orleans", "NOP", "L", "Matt",
  "Orlando Magic", "Magic|Orlando", "ORL", "W", "Kenneth",
  "Chicago Bulls", "Bulls|Chicago", "CHI", "L", "Thomas",
  "Los Angeles Clippers", "Clippers|LA Clippers", "LAC", "W", "Eristeo",
  "Minnesota Timberwolves", "Timberwolves|Minnesota", "MIN", "W", "Matt",
  "Portland Trail Blazers", "Trail Blazers|Portland", "POR", "L", "Kenneth",
  "Atlanta Hawks", "Hawks|Atlanta", "ATL", "W", "Adam",
  "Los Angeles Lakers", "Lakers|LA Lakers", "LAL", "W", "Adam",
  "Golden State Warriors", "Warriors|Golden State", "GSW", "W", "Kenneth",
  "Sacramento Kings", "Kings|Sacramento", "SAC", "L", "Thomas",
  "Detroit Pistons", "Pistons|Detroit", "DET", "W", "Brian",
  "Indiana Pacers", "Pacers|Indiana", "IND", "L", "Eristeo",
  "Miami Heat", "Heat|Miami", "MIA", "L", "Matt",
  "Philadelphia 76ers", "76ers|Philadelphia", "PHI", "W", "Matt",
  "Toronto Raptors", "Raptors|Toronto", "TOR", "L", "Brian",
  "Milwaukee Bucks", "Bucks|Milwaukee", "MIL", "W", "Brian",
  "San Antonio Spurs", "Spurs|San Antonio", "SAS", "W", "Eristeo",
  "Memphis Grizzlies", "Grizzlies|Memphis", "MEM", "W", "Kenneth",
  "Boston Celtics", "Celtics|Boston", "BOS", "W", "Adam",
  "Dallas Mavericks", "Mavericks|Dallas", "DAL", "W", "Thomas"
)

# --- Part 3: Calculate Expected Skins ---
convert_odds_to_prob <- function(odds) {
  prob <- case_when(
    odds < 0 ~ abs(odds) / (abs(odds) + 100),
    odds > 0 ~ 100 / (odds + 100),
    TRUE ~ NA_real_
  )
  return(prob)
}

today_ct <- as_date(now(tzone = "America/Chicago"))
current_year <- year(today_ct)

# Use 3am cutoff: if it's before 3am, use yesterday's date for results
# This captures late games that finish after midnight
current_time_ct <- now(tzone = "America/Chicago")
if (hour(current_time_ct) < 3) {
  results_date <- today_ct - days(1)
} else {
  results_date <- today_ct
}

# FIXED: Use word boundaries to prevent "Hornets" from matching "Nets"
match_team <- function(matchup_str, draft_data) {
  matchup_upper <- str_to_upper(matchup_str)
  for (i in 1:nrow(draft_data)) {
    keys <- str_split(draft_data$Matchup_Key[i], "\\|")[[1]]
    keys_upper <- str_to_upper(keys)
    
    # Check if any of the keys match (with word boundaries)
    for (key in keys_upper) {
      pattern <- paste0("\\b", key, "\\b")
      if (str_detect(matchup_upper, regex(pattern))) {
        return(draft_data$Matchup_Key[i])
      }
    }
  }
  return(NA_character_)
}

# Parse based on actual structure
todays_picks <- game_data %>%
  filter(!is.na(Matchup) & Matchup != "") %>%
  mutate(
    row_id = row_number(),
    game_time_str = str_extract(Matchup_raw, 
      "(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\\s+\\d+,\\s+\\d+:\\d+\\s*[AP]M\\s+UTC")
  ) %>%
  # Fill UP because date rows come AFTER team rows
  fill(game_time_str, .direction = "up") %>%
  # Filter out the "Expert Picks" and "Advanced Insights" rows
  filter(!str_detect(Matchup, "Expert Picks|Advanced Insights")) %>%
  # Only keep rows with actual odds (contains +/- numbers)
  filter(str_detect(consensus, "[+-]\\d+")) %>%
  mutate(
    Matchup_Key = vapply(Matchup, match_team, draft_data = draft_data, FUN.VALUE = character(1)),
    game_time_str_with_year = paste(game_time_str, current_year),
    game_time_utc = parse_date_time(
      str_remove(game_time_str_with_year, "\\s+UTC"),
      orders = c("b d, I:M p Y"),
      tz = "UTC"
    ),
    game_time_ct = with_tz(game_time_utc, tzone = "America/Chicago"),
    game_date_ct = as_date(game_time_ct),
    # Create game_id: every 2 consecutive rows are a game
    game_id = paste0(game_date_ct, "_", ceiling(row_number() / 2))
  ) %>%
  filter(game_date_ct == today_ct, !is.na(Matchup_Key)) %>%
  mutate(
    # Extract odds from format like "-175Open: -189"
    moneyline = as.numeric(str_extract(consensus, "^[+-]?\\d+")),
    opening_odds = as.numeric(str_extract(consensus, "(?<=Open: )[+-]?\\d+"))
  ) %>%
  # Remove duplicates - keep one row per team per game
  distinct(Matchup_Key, game_id, .keep_all = TRUE) %>%
  mutate(implied_prob = convert_odds_to_prob(moneyline)) %>%
  group_by(game_id) %>%
  mutate(
    total_prob_in_game = sum(implied_prob, na.rm = TRUE),
    prob_no_vig = implied_prob / total_prob_in_game
  ) %>%
  ungroup() %>%
  left_join(draft_data, by = "Matchup_Key") %>%
  filter(!is.na(Team)) %>%
  mutate(
    expected_skins = if_else(skins_pick == "W", prob_no_vig, 1 - prob_no_vig),
    Date = today_ct
  ) %>%
  select(Date, Team, Pick = skins_pick, "Expected Skins" = expected_skins,
         Player = player, Moneyline = moneyline, "Implied Prob" = prob_no_vig,
         Abbr = abbr, game_id) %>%
  arrange(desc(`Expected Skins`))
```

```{r expected_player_table}
#| echo: false

# Print Table 1: Total Expected Skins by Player
if (nrow(todays_picks) > 0) {
  
  # First, identify self zero-sum matchups (same player has both teams AND both picks are the same)
  self_zero_sum <- todays_picks %>%
    group_by(game_id) %>%
    filter(n() == 2) %>%
    summarise(
      players = list(Player),
      picks = list(Pick),
      is_self_zero_sum = length(unique(Player)) == 1 & length(unique(Pick)) == 1,
      player = first(Player),
      .groups = 'drop'
    ) %>%
    filter(is_self_zero_sum) %>%
    group_by(player) %>%
    summarise(self_zero_sum_count = n(), .groups = 'drop')
  
  # Create player summary
  player_summary <- todays_picks %>%
    group_by(Player) %>%
    summarise(
      `Total Games` = n(),
      `Total Expected Skins` = sum(`Expected Skins`, na.rm = TRUE),
      expected_skins_probs = list(`Expected Skins`),
      .groups = 'drop'
    ) %>%
    left_join(self_zero_sum, by = c("Player" = "player")) %>%
    mutate(
      self_zero_sum_count = ifelse(is.na(self_zero_sum_count), 0, self_zero_sum_count),
      `Max Skins` = `Total Games` - self_zero_sum_count,
      `Expected Skins %` = paste0(sprintf("%.0f", (`Total Expected Skins` / `Total Games`) * 100), "%"),
      # Perfect Skins Probability: only possible if player has exactly 5 games with no self zero-sum
      `Perfect Skins Probability` = ifelse(
        `Max Skins` == 5 & `Total Games` == 5,
        paste0(sprintf("%.0f", prod(unlist(expected_skins_probs)) * 100), "%"),
        "0%"
      )
    ) %>%
    select(Player, `Total Games`, `Total Expected Skins`, `Expected Skins %`, `Max Skins`, `Perfect Skins Probability`) %>%
    arrange(desc(`Total Expected Skins`))
  
  knitr::kable(player_summary, digits = 1, align = 'c', caption = "Total Expected Skins by Player") %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)
}
```

```{r zero_sum_table}
#| echo: false

# Print Table 2: Zero-Sum Matchups
if (nrow(todays_picks) > 0) {
  zero_sum_games <- todays_picks %>%
    group_by(game_id) %>%
    filter(
      n() == 2, # Exactly 2 teams in the game
      (all(Pick == "W") | all(Pick == "L")) # Both W or both L (creates zero-sum)
    ) %>%
    mutate(
      matchup_type = if_else(all(Pick == "W"), "Both W", "Both L"),
      matchup_str = paste0(Abbr, " (", Player, ")")
    ) %>%
    summarise(
      `Zero-Sum Matchup` = paste(matchup_str, collapse = " vs. "),
      Type = first(matchup_type),
      .groups = 'drop'
    )
  
  if (nrow(zero_sum_games) > 0) {
    knitr::kable(select(zero_sum_games, -game_id), align = 'c', caption = "Today's Zero-Sum Matchups") %>%
      kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE) %>%
      row_spec(0, bold = TRUE, color = "white", background = "#444444")
  } else {
    cat("No zero-sum matchups today.")
  }
}
```

```{r expected_team_table}
#| echo: false

# Print Table 3: Today's Expected Skins by Team
if (nrow(todays_picks) > 0) {
  team_table_data <- todays_picks %>%
    mutate(`Implied Prob` = paste0(sprintf("%.0f", `Implied Prob` * 100), "%")) %>%
    select(-game_id, -Abbr, -Date) %>%
    arrange(Player, Team)
  
  knitr::kable(
    team_table_data, 
    digits = 1, 
    align = 'c',
    caption = "Today's Expected Skins by Team"
  ) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE) %>%
    column_spec(3, bold = TRUE)
} else {
  cat("No games scheduled for today.")
}
```

---

## Today's Results & Skins Luck

This section scrapes `cleaningtheglass.com` for game results. Games that are final or in-progress will appear here.

```{r matchup_table}
#| echo: false
#| message: false
#| warning: false

# Create Head-to-Head Matchup Table
if (nrow(todays_picks) > 0) {
  
  # First, scrape results to check game status
  url_scores <- paste0("https://cleaningtheglass.com/stats/games/?date=", results_date)
  page_scores <- read_html(url_scores)
  all_tables <- page_scores %>% html_elements("table")
  
  # Extract game results and status
  matchup_game_results <- data.frame()
  
  for (i in 1:length(all_tables)) {
    table_data <- all_tables[[i]] %>% html_table()
    
    # Check if game is final
    is_final <- FALSE
    if (nrow(table_data) >= 3) {
      status_row <- paste(unlist(table_data[3, ]), collapse = " ")
      is_final <- grepl("Final", status_row, ignore.case = TRUE)
    }
    
    # Extract scores
    if (ncol(table_data) >= 3) {
      game_scores <- table_data %>%
        select(Abbr = 2, PTS_Str = 3) %>%
        mutate(
          Abbr = as.character(Abbr),
          PTS = suppressWarnings(as.numeric(as.character(PTS_Str)))
        ) %>%
        filter(!is.na(PTS), PTS > 0) %>%
        select(Abbr, PTS) %>%
        mutate(is_final = is_final)
      
      if (nrow(game_scores) > 0) {
        matchup_game_results <- bind_rows(matchup_game_results, game_scores)
      }
    }
  }
  
  # Create wide format for game results (only final games)
  matchup_results_wide <- matchup_game_results %>%
    filter(is_final == TRUE) %>%
    mutate(Game_ID = ceiling(row_number() / 2)) %>%
    group_by(Game_ID) %>%
    mutate(Team_Num = row_number()) %>%
    ungroup() %>%
    pivot_wider(
      id_cols = Game_ID,
      names_from = Team_Num,
      values_from = c(Abbr, PTS)
    )
  
  # Create Won_Game lookup
  matchup_won_lookup <- data.frame(Abbr = character(), Won_Game = logical())
  
  if (nrow(matchup_results_wide) > 0) {
    team_1 <- matchup_results_wide %>%
      select(Abbr = Abbr_1, PTS = PTS_1, Opp_PTS = PTS_2) %>%
      mutate(Won_Game = PTS > Opp_PTS)
    
    team_2 <- matchup_results_wide %>%
      select(Abbr = Abbr_2, PTS = PTS_2, Opp_PTS = PTS_1) %>%
      mutate(Won_Game = PTS > Opp_PTS)
    
    matchup_won_lookup <- bind_rows(team_1, team_2) %>%
      select(Abbr, Won_Game)
  }
  
  # Build the matchup table - ONE ROW PER GAME
  matchup_prep <- todays_picks %>%
    left_join(matchup_won_lookup, by = "Abbr") %>%
    mutate(
      Won_Skin = case_when(
        Won_Game == TRUE & Pick == "W" ~ TRUE,
        Won_Game == FALSE & Pick == "L" ~ TRUE,
        is.na(Won_Game) ~ NA,
        TRUE ~ FALSE
      ),
      Game_Status = ifelse(is.na(Won_Game), "Not Started", "Final")
    ) %>%
    arrange(game_id)
  
  # Create one row per game with both players
  matchup_table <- matchup_prep %>%
    group_by(game_id) %>%
    summarise(
      Player_1 = first(Player),
      Team_1 = first(Team),
      Pick_1 = first(Pick),
      Won_Skin_1 = first(Won_Skin),
      Player_2 = if(n() > 1) nth(Player, 2) else NA_character_,
      Team_2 = if(n() > 1) nth(Team, 2) else NA_character_,
      Pick_2 = if(n() > 1) nth(Pick, 2) else NA_character_,
      Won_Skin_2 = if(n() > 1) nth(Won_Skin, 2) else NA,
      Status = first(Game_Status),
      .groups = 'drop'
    ) %>%
    mutate(
      # Format player names with color highlighting using format="html"
      Player_1_Display = case_when(
        Status == "Final" & !is.na(Won_Skin_1) & Won_Skin_1 ~ 
          cell_spec(Player_1, background = "#90EE90", bold = TRUE, format = "html"),
        Status == "Final" & !is.na(Won_Skin_1) & !Won_Skin_1 ~ 
          cell_spec(Player_1, background = "#FFB6C6", bold = TRUE, format = "html"),
        TRUE ~ Player_1
      ),
      Player_2_Display = case_when(
        is.na(Player_2) ~ "",
        Status == "Final" & !is.na(Won_Skin_2) & Won_Skin_2 ~ 
          cell_spec(Player_2, background = "#90EE90", bold = TRUE, format = "html"),
        Status == "Final" & !is.na(Won_Skin_2) & !Won_Skin_2 ~ 
          cell_spec(Player_2, background = "#FFB6C6", bold = TRUE, format = "html"),
        TRUE ~ Player_2
      ),
      # Add checkmarks for Won_Skin status
      Won_1 = case_when(
        is.na(Won_Skin_1) ~ "",
        Won_Skin_1 ~ "✓ Yes",
        TRUE ~ "✗ No"
      ),
      Won_2 = case_when(
        is.na(Player_2) ~ "",
        is.na(Won_Skin_2) ~ "",
        Won_Skin_2 ~ "✓ Yes",
        TRUE ~ "✗ No"
      ),
      # Create vs. display
      VS = if_else(is.na(Player_2), "", "vs."),
      Team_2_Display = if_else(is.na(Team_2), "", Team_2),
      Pick_2_Display = if_else(is.na(Pick_2), "", Pick_2)
    ) %>%
    select(
      Player = Player_1_Display,
      Team = Team_1,
      Pick = Pick_1,
      `Won Skin` = Won_1,
      VS,
      `Player 2` = Player_2_Display,
      `Team 2` = Team_2_Display,
      `Pick 2` = Pick_2_Display,
      `Won Skin 2` = Won_2,
      Status
    )
  
  # Create the table with HTML formatting enabled
  knitr::kable(
    matchup_table,
    align = 'c',
    caption = "Head-to-Head Matchups",
    escape = FALSE,  # Allow HTML formatting from cell_spec
    format = "html"  # Explicitly set format to HTML
  ) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)
  
} else {
  cat("No games scheduled for today.")
}
```

```{r results_and_luck}
#| echo: false
#| message: false
#| warning: false

# Only process results if we have games today
if (nrow(todays_picks) > 0) {
  
  # 1. Scrape the Live Game Data with date parameter
  # Use results_date to capture late games that finish after midnight
  url_scores <- paste0("https://cleaningtheglass.com/stats/games/?date=", results_date)
  page_scores <- read_html(url_scores)
  
  # 2. Get all tables (each table contains one game)
  all_tables <- page_scores %>% html_elements("table")
  
  # 3. Extract scores from all tables and track game status
  all_game_results <- data.frame()
  
  for (i in 1:length(all_tables)) {
    table_data <- all_tables[[i]] %>% html_table()
    
    # Check game status from row 3 (status row)
    # "Final" = completed, "Live" = in-progress, "Game Preview" = unstarted
    is_final <- FALSE
    if (nrow(table_data) >= 3) {
      status_row <- paste(unlist(table_data[3, ]), collapse = " ")
      is_final <- grepl("Final", status_row, ignore.case = TRUE)
    }
    
    # Try to extract game scores (team abbr in col 2, points in col 3)
    if (ncol(table_data) >= 3) {
      game_scores <- table_data %>%
        select(Abbr = 2, PTS_Str = 3) %>%
        mutate(
          Abbr = as.character(Abbr),
          PTS = suppressWarnings(as.numeric(as.character(PTS_Str)))
        ) %>%
        filter(!is.na(PTS), PTS > 0) %>%
        select(Abbr, PTS) %>%
        mutate(is_final = is_final)
      
      if (nrow(game_scores) > 0) {
        all_game_results <- bind_rows(all_game_results, game_scores)
      }
    }
  }
  
  # 4. Clean and Reshape the game results - ONLY INCLUDE FINAL GAMES
  game_results_wide <- all_game_results %>%
    filter(is_final == TRUE) %>%
    mutate(Game_ID = ceiling(row_number() / 2)) %>%
    group_by(Game_ID) %>%
    mutate(Team_Num = row_number()) %>%
    ungroup() %>%
    pivot_wider(
      id_cols = Game_ID,
      names_from = Team_Num,
      values_from = c(Abbr, PTS)
    )
  
  # 5. Create a final 'Won_Game' lookup table
  final_team_results <- data.frame(Abbr = character(), Won_Game = logical())
  
  if (nrow(game_results_wide) > 0) {
    team_1_results <- game_results_wide %>%
      select(Abbr = Abbr_1, PTS = PTS_1, Opp_PTS = PTS_2) %>%
      mutate(Won_Game = PTS > Opp_PTS)
    
    team_2_results <- game_results_wide %>%
      select(Abbr = Abbr_2, PTS = PTS_2, Opp_PTS = PTS_1) %>%
      mutate(Won_Game = PTS > Opp_PTS)
    
    final_team_results <- bind_rows(team_1_results, team_2_results) %>%
      select(Abbr, Won_Game)
  }
  
  # 6. Create todays_results with actual outcomes
  todays_results <- todays_picks %>%
    left_join(final_team_results, by = "Abbr") %>%
    mutate(
      Actual_Skins = case_when(
        Won_Game == TRUE & Pick == "W" ~ 1,
        Won_Game == FALSE & Pick == "L" ~ 1,
        is.na(Won_Game) ~ NA_real_,
        TRUE ~ 0
      ),
      Skins_Luck = Actual_Skins - `Expected Skins`
    )
  
  # 7. Save today's results to file (use underscores for easier CSV handling)
  today_file <- file.path(history_dir, paste0(today_ct, ".csv"))
  todays_results %>%
    select(Date, Player, Team, Abbr, Pick, Expected_Skins = `Expected Skins`, Won_Game, Actual_Skins, Skins_Luck) %>%
    write_csv(today_file)
  
  # 8. Print Table 4: Completed Games Summary
  completed_games_table <- todays_results %>%
    filter(!is.na(Won_Game)) %>%
    select(
      Player,
      Team,
      Pick,
      `Won Game?` = Won_Game,
      `Actual Skins` = Actual_Skins,
      `Expected Skins`,
      `Skins Luck` = Skins_Luck
    ) %>%
    arrange(Player, Team)
  
  if (nrow(completed_games_table) > 0) {
    knitr::kable(completed_games_table, digits = 1, align = 'c', caption = "Skins Results for Completed Games") %>%
      kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE) %>%
      column_spec(c(5, 7), bold = TRUE)
  } else {
    cat("No games have been completed yet today.")
  }
  
} else {
  cat("No games scheduled for today.")
}
```

```{r final_player_summary}
#| echo: false
#| message: false
#| warning: false

# Print Table 5: Final Player Summary
if (exists("todays_results") && nrow(todays_results) > 0) {
  final_player_summary <- todays_results %>%
    group_by(Player) %>%
    summarise(
      `Total Expected Skins` = sum(`Expected Skins`, na.rm = TRUE),
      `Total Actual Skins` = sum(Actual_Skins, na.rm = TRUE),
      `Skins Luck` = sum(Skins_Luck, na.rm = TRUE),
      .groups = 'drop'
    ) %>%
    arrange(desc(`Skins Luck`))
  
  knitr::kable(
    final_player_summary,
    digits = 1,
    align = 'c',
    caption = "Final Player Summary (Expected vs. Actual)"
  ) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE) %>%
    column_spec(4, bold = TRUE)
}
```

---

## Yesterday's Results (Work in Progress)


```{r yesterday_matchup_table}
#| echo: false
#| message: false
#| warning: false

# Create Yesterday's Head-to-Head Matchup Table
yesterday_ct <- today_ct - days(1)
yesterday_file <- file.path(history_dir, paste0(yesterday_ct, ".csv"))

if (file.exists(yesterday_file)) {
  yesterday_data <- read_csv(yesterday_file, show_col_types = FALSE)
  
  if (nrow(yesterday_data) > 0) {
    
    # Scrape yesterday's game results from cleaningtheglass.com
    url_scores_yesterday <- paste0("https://cleaningtheglass.com/stats/games/?date=", yesterday_ct)
    page_scores_yesterday <- read_html(url_scores_yesterday)
    all_tables_yesterday <- page_scores_yesterday %>% html_elements("table")
    
    # Extract game results
    yesterday_game_results <- data.frame()
    
    for (i in 1:length(all_tables_yesterday)) {
      table_data <- all_tables_yesterday[[i]] %>% html_table()
      
      # Check if game is final
      is_final <- FALSE
      if (nrow(table_data) >= 3) {
        status_row <- paste(unlist(table_data[3, ]), collapse = " ")
        is_final <- grepl("Final", status_row, ignore.case = TRUE)
      }
      
      # Extract scores
      if (ncol(table_data) >= 3) {
        game_scores <- table_data %>%
          select(Abbr = 2, PTS_Str = 3) %>%
          mutate(
            Abbr = as.character(Abbr),
            PTS = suppressWarnings(as.numeric(as.character(PTS_Str)))
          ) %>%
          filter(!is.na(PTS), PTS > 0) %>%
          select(Abbr, PTS) %>%
          mutate(is_final = is_final)
        
        if (nrow(game_scores) > 0) {
          yesterday_game_results <- bind_rows(yesterday_game_results, game_scores)
        }
      }
    }
    
    # Create wide format for game results to determine winners
    yesterday_results_wide <- yesterday_game_results %>%
      filter(is_final == TRUE) %>%
      mutate(Game_ID = ceiling(row_number() / 2)) %>%
      group_by(Game_ID) %>%
      mutate(Team_Num = row_number()) %>%
      ungroup() %>%
      pivot_wider(
        id_cols = Game_ID,
        names_from = Team_Num,
        values_from = c(Abbr, PTS)
      )
    
    # Create Won_Game lookup based on actual scores
    yesterday_won_lookup <- data.frame(Abbr = character(), Won_Game = logical())
    
    if (nrow(yesterday_results_wide) > 0) {
      team_1 <- yesterday_results_wide %>%
        select(Abbr = Abbr_1, PTS = PTS_1, Opp_PTS = PTS_2) %>%
        mutate(Won_Game = PTS > Opp_PTS)  # TRUE if team won
      
      team_2 <- yesterday_results_wide %>%
        select(Abbr = Abbr_2, PTS = PTS_2, Opp_PTS = PTS_1) %>%
        mutate(Won_Game = PTS > Opp_PTS)  # TRUE if team won
      
      yesterday_won_lookup <- bind_rows(team_1, team_2) %>%
        select(Abbr, Won_Game)
    }
    
    # Add game_id to scraped results
    yesterday_abbr_order <- yesterday_game_results %>%
      filter(is_final == TRUE) %>%
      mutate(game_id = paste0("game_", ceiling(row_number() / 2)))
    
    # Match yesterday_data with game results and calculate Won_Skin correctly
    yesterday_with_game <- yesterday_data %>%
      left_join(
        yesterday_abbr_order %>% select(Abbr, game_id),
        by = "Abbr"
      ) %>%
      left_join(yesterday_won_lookup, by = "Abbr")
    
    # Check if Won_Game column exists, if not create it as NA
    if (!"Won_Game" %in% names(yesterday_with_game)) {
      yesterday_with_game <- yesterday_with_game %>%
        mutate(Won_Game = NA)
    }
    
    yesterday_with_game <- yesterday_with_game %>%
      mutate(
        # CORRECT LOGIC: Win skin when (Pick=W AND Won_Game=TRUE) OR (Pick=L AND Won_Game=FALSE)
        Won_Skin = case_when(
          is.na(Won_Game) ~ NA,  # Game not found
          Pick == "W" & Won_Game == TRUE ~ TRUE,   # Picked W, team won
          Pick == "L" & Won_Game == FALSE ~ TRUE,  # Picked L, team lost
          TRUE ~ FALSE  # All other cases = no skin
        ),
        Game_Status = ifelse(is.na(Won_Game), "Not Started", "Final")
      ) %>%
      arrange(game_id)
    
    # Build the matchup table - ONE ROW PER GAME
    yesterday_matchup_table <- yesterday_with_game %>%
      filter(!is.na(game_id)) %>%
      group_by(game_id) %>%
      summarise(
        Player_1 = first(Player),
        Team_1 = first(Team),
        Pick_1 = first(Pick),
        Won_Skin_1 = first(Won_Skin),
        Player_2 = if(n() > 1) nth(Player, 2) else NA_character_,
        Team_2 = if(n() > 1) nth(Team, 2) else NA_character_,
        Pick_2 = if(n() > 1) nth(Pick, 2) else NA_character_,
        Won_Skin_2 = if(n() > 1) nth(Won_Skin, 2) else NA,
        Status = first(Game_Status),
        .groups = 'drop'
      ) %>%
      mutate(
        # Format player names with color highlighting using format="html"
        Player_1_Display = case_when(
          !is.na(Won_Skin_1) & Won_Skin_1 == TRUE ~ 
            cell_spec(Player_1, background = "#90EE90", bold = TRUE, format = "html"),
          !is.na(Won_Skin_1) & Won_Skin_1 == FALSE ~ 
            cell_spec(Player_1, background = "#FFB6C6", bold = TRUE, format = "html"),
          TRUE ~ Player_1
        ),
        Player_2_Display = case_when(
          is.na(Player_2) ~ "",
          !is.na(Won_Skin_2) & Won_Skin_2 == TRUE ~ 
            cell_spec(Player_2, background = "#90EE90", bold = TRUE, format = "html"),
          !is.na(Won_Skin_2) & Won_Skin_2 == FALSE ~ 
            cell_spec(Player_2, background = "#FFB6C6", bold = TRUE, format = "html"),
          TRUE ~ Player_2
        ),
        # Add checkmarks for Won_Skin status
        Won_1 = case_when(
          is.na(Won_Skin_1) ~ "",
          Won_Skin_1 == TRUE ~ "✓ Yes",
          Won_Skin_1 == FALSE ~ "✗ No",
          TRUE ~ ""
        ),
        Won_2 = case_when(
          is.na(Player_2) ~ "",
          is.na(Won_Skin_2) ~ "",
          Won_Skin_2 == TRUE ~ "✓ Yes",
          Won_Skin_2 == FALSE ~ "✗ No",
          TRUE ~ ""
        ),
        # Create vs. display
        VS = if_else(is.na(Player_2), "", "vs."),
        Team_2_Display = if_else(is.na(Team_2), "", Team_2),
        Pick_2_Display = if_else(is.na(Pick_2), "", Pick_2)
      ) %>%
      select(
        Player = Player_1_Display,
        Team = Team_1,
        Pick = Pick_1,
        `Won Skin` = Won_1,
        VS,
        `Player 2` = Player_2_Display,
        `Team 2` = Team_2_Display,
        `Pick 2` = Pick_2_Display,
        `Won Skin 2` = Won_2,
        Status
      )
    
    # Create the table with HTML formatting enabled
    if (nrow(yesterday_matchup_table) > 0) {
      knitr::kable(
        yesterday_matchup_table,
        align = 'c',
        caption = paste0(format(yesterday_ct, "%B %d, %Y"), " - Head-to-Head Matchups"),
        escape = FALSE,  # Allow HTML formatting from cell_spec
        format = "html"  # Explicitly set format to HTML
      ) %>%
        kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)
    } else {
      cat(paste0("No completed games found for ", format(yesterday_ct, "%A, %B %d, %Y"), "."))
    }
  } else {
    cat(paste0("No data available for ", format(yesterday_ct, "%A, %B %d, %Y"), "."))
  }
} else {
  cat(paste0("No data available for ", format(yesterday_ct, "%A, %B %d, %Y"), "."))
}
```

```{r yesterday_results}
#| echo: false
#| message: false
#| warning: false

yesterday_ct <- today_ct - days(1)
yesterday_file <- file.path(history_dir, paste0(yesterday_ct, ".csv"))

if (file.exists(yesterday_file)) {
  yesterday_data <- read_csv(yesterday_file, show_col_types = FALSE)
  
  # Yesterday's Completed Games
  yesterday_completed <- yesterday_data %>%
    filter(!is.na(Won_Game)) %>%
    select(
      Player,
      Team,
      Pick,
      Won_Game,
      Actual_Skins,
      Expected_Skins,
      Skins_Luck
    ) %>%
    rename(
      `Won Game?` = Won_Game,
      `Actual Skins` = Actual_Skins,
      `Expected Skins` = Expected_Skins,
      `Skins Luck` = Skins_Luck
    ) %>%
    arrange(Player, Team)
  
  if (nrow(yesterday_completed) > 0) {
    cat(paste0("<h3>", format(yesterday_ct, "%A, %B %d, %Y"), " - Skins Results</h3>"))
    
    knitr::kable(yesterday_completed, digits = 1, align = 'c') %>%
      kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE) %>%
      column_spec(c(5, 7), bold = TRUE)
    
    # Yesterday's Player Summary
    yesterday_player_summary <- yesterday_data %>%
      group_by(Player) %>%
      summarise(
        Total_Expected_Skins = sum(Expected_Skins, na.rm = TRUE),
        Total_Actual_Skins = sum(Actual_Skins, na.rm = TRUE),
        Skins_Luck_Total = sum(Skins_Luck, na.rm = TRUE),
        .groups = 'drop'
      ) %>%
      rename(
        `Total Expected Skins` = Total_Expected_Skins,
        `Total Actual Skins` = Total_Actual_Skins,
        `Skins Luck` = Skins_Luck_Total
      ) %>%
      arrange(desc(`Skins Luck`))
    
    cat("<br>")
    knitr::kable(
      yesterday_player_summary,
      digits = 1,
      align = 'c',
      caption = paste0(format(yesterday_ct, "%B %d"), " - Player Summary")
    ) %>%
      kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE) %>%
      column_spec(4, bold = TRUE)
  } else {
    cat(paste0("No completed games found for ", format(yesterday_ct, "%A, %B %d, %Y"), "."))
  }
} else {
  cat(paste0("No data available for ", format(yesterday_ct, "%A, %B %d, %Y"), "."))
}
```

---

## Year-to-Date Cumulative Stats (work in progress)

```{r ytd_cumulative}
#| echo: false
#| message: false
#| warning: false

# Read all historical files
all_files <- list.files(history_dir, pattern = "\\.csv$", full.names = TRUE)

if (length(all_files) > 0) {
  # Read and combine all historical data using base R
  all_history <- bind_rows(lapply(all_files, function(f) read_csv(f, show_col_types = FALSE)))
  
  # Filter for current year only
  current_year <- year(today_ct)
  ytd_data <- all_history %>%
    filter(year(Date) == current_year, !is.na(Actual_Skins))
  
  if (nrow(ytd_data) > 0) {
    ytd_summary <- ytd_data %>%
      group_by(Player) %>%
      summarise(
        Games = n(),
        Total_Expected_Skins = sum(Expected_Skins, na.rm = TRUE),
        Total_Actual_Skins = sum(Actual_Skins, na.rm = TRUE),
        Cumulative_Skins_Luck = sum(Skins_Luck, na.rm = TRUE),
        .groups = 'drop'
      ) %>%
      mutate(
        Avg_Skins_Luck_per_Game = Cumulative_Skins_Luck / Games
      ) %>%
      rename(
        `Total Expected Skins` = Total_Expected_Skins,
        `Total Actual Skins` = Total_Actual_Skins,
        `Cumulative Skins Luck` = Cumulative_Skins_Luck,
        `Avg Skins Luck per Game` = Avg_Skins_Luck_per_Game
      ) %>%
      arrange(desc(`Cumulative Skins Luck`))
    
    knitr::kable(
      ytd_summary,
      digits = 1,
      align = 'c',
      caption = paste0(current_year, " Year-to-Date Cumulative Stats")
    ) %>%
      kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE) %>%
      column_spec(5, bold = TRUE)
  } else {
    cat("No completed games in year-to-date history.")
  }
} else {
  cat("No historical data available yet.")
}
```
