---
title: "YTD Stats Diagnostic Report"
format:
  html:
    self-contained: true
    theme: default
---

```{r setup}
#| echo: false
#| message: false
#| warning: false
library(dplyr)
library(readr)
library(lubridate)
library(stringr)
library(knitr)

history_dir <- "skins_history"

# Current time and date calculations
current_time_ct <- now(tzone = "America/Chicago")
current_hour_ct <- hour(current_time_ct)

if (current_hour_ct < 2) {
  skins_date <- as_date(current_time_ct) - days(1)
} else {
  skins_date <- as_date(current_time_ct)
}

today_ct <- skins_date
current_year <- year(today_ct)
```

# YTD Stats Diagnostic Report
**Generated:** `r format(Sys.time(), "%Y-%m-%d %H:%M:%S %Z")`

---

## 1. Current Date & Time Settings

```{r datetime_check}
#| echo: false
cat("Current Time (Chicago):", as.character(current_time_ct), "\n")
cat("Current Hour:", current_hour_ct, "\n")
cat("Skins Date (today_ct):", as.character(today_ct), "\n")
cat("Current Year:", current_year, "\n")
```

---

## 2. Baseline Configuration Check

```{r baseline_check}
#| echo: false
baseline_date_file <- file.path(history_dir, "baseline_date.txt")
historical_file <- file.path(history_dir, "ytd_baseline.csv")

cat("=== BASELINE FILES ===\n")
cat("1. baseline_date.txt exists:", file.exists(baseline_date_file), "\n")
if (file.exists(baseline_date_file)) {
  baseline_date_content <- readLines(baseline_date_file)
  cat("   Contents:", baseline_date_content, "\n")
  baseline_date <- as_date(baseline_date_content[1])
  cat("   Parsed date:", as.character(baseline_date), "\n")
} else {
  cat("   FILE MISSING!\n")
  baseline_date <- NA
}

cat("\n2. ytd_baseline.csv exists:", file.exists(historical_file), "\n")
if (file.exists(historical_file)) {
  ytd_baseline <- read_csv(historical_file, show_col_types = FALSE)
  cat("   Row count:", nrow(ytd_baseline), "\n")
  print(kable(ytd_baseline, caption = "Current ytd_baseline.csv contents"))
} else {
  cat("   FILE MISSING!\n")
}
```

---

## 3. Historical CSV Files Inventory

```{r csv_inventory}
#| echo: false
cat("=== CSV FILES IN HISTORY DIRECTORY ===\n")
all_files <- list.files(history_dir, pattern = "^\\d{4}-\\d{2}-\\d{2}\\.csv$", full.names = FALSE)

if (length(all_files) > 0) {
  file_dates <- as_date(str_extract(all_files, "\\d{4}-\\d{2}-\\d{2}"))
  file_info <- data.frame(
    Filename = all_files,
    Date = file_dates,
    Exists = TRUE,
    stringsAsFactors = FALSE
  ) %>%
    arrange(Date)
  
  print(kable(file_info, caption = "Historical CSV Files"))
  
  cat("\nDate Range:", as.character(min(file_dates)), "to", as.character(max(file_dates)), "\n")
} else {
  cat("NO CSV FILES FOUND!\n")
}
```

---

## 4. CSV File Contents Analysis

```{r csv_contents}
#| echo: false
#| results: 'asis'
if (length(all_files) > 0) {
  for (file in all_files) {
    cat("\n### File:", file, "\n\n")
    file_path <- file.path(history_dir, file)
    file_data <- read_csv(file_path, show_col_types = FALSE)
    
    cat("- Rows:", nrow(file_data), "\n")
    cat("- Columns:", paste(names(file_data), collapse = ", "), "\n")
    cat("- Players:", paste(unique(file_data$Player), collapse = ", "), "\n")
    cat("- Completed games:", sum(!is.na(file_data$Won_Game)), "\n")
    cat("- Pending games:", sum(is.na(file_data$Won_Game)), "\n\n")
    
    print(kable(file_data, caption = paste("Contents of", file)))
    cat("\n")
  }
}
```

---

## 5. File Filtering Logic Test

```{r filtering_logic}
#| echo: false
cat("=== TESTING FILE FILTERING LOGIC ===\n\n")

if (!is.na(baseline_date)) {
  cat("Baseline date:", as.character(baseline_date), "\n")
  cat("Today's date:", as.character(today_ct), "\n\n")
  
  if (length(all_files) > 0) {
    cat("File filtering test:\n")
    for (file in all_files) {
      file_date <- as_date(str_extract(file, "\\d{4}-\\d{2}-\\d{2}"))
      passes_filter <- !is.na(file_date) && file_date >= baseline_date
      cat(sprintf("  %s (date: %s) - Passes filter (>= %s): %s\n", 
                  file, as.character(file_date), as.character(baseline_date), passes_filter))
    }
    
    # Get valid files
    valid_files <- all_files[sapply(all_files, function(f) {
      file_date <- as_date(str_extract(f, "\\d{4}-\\d{2}-\\d{2}"))
      return(!is.na(file_date) && file_date >= baseline_date)
    })]
    
    cat("\n", length(valid_files), "files pass the filter\n")
    cat("Valid files:", paste(valid_files, collapse = ", "), "\n")
  }
} else {
  cat("ERROR: Cannot test filtering - baseline_date is NA\n")
}
```

---

## 6. YTD Data Aggregation Test

```{r ytd_aggregation}
#| echo: false
cat("=== TESTING YTD DATA AGGREGATION ===\n\n")

if (!is.na(baseline_date) && length(all_files) > 0) {
  valid_files <- all_files[sapply(all_files, function(f) {
    file_date <- as_date(str_extract(f, "\\d{4}-\\d{2}-\\d{2}"))
    return(!is.na(file_date) && file_date >= baseline_date)
  })]
  
  if (length(valid_files) > 0) {
    valid_file_paths <- file.path(history_dir, valid_files)
    all_history <- bind_rows(lapply(valid_file_paths, function(f) read_csv(f, show_col_types = FALSE)))
    
    cat("Total rows from all valid files:", nrow(all_history), "\n")
    cat("Date range in data:", as.character(min(all_history$Date)), "to", as.character(max(all_history$Date)), "\n\n")
    
    # Filter for current year and completed games
    ytd_data <- all_history %>%
      filter(year(Date) == current_year, !is.na(Actual_Skins))
    
    cat("After filtering for year", current_year, "and completed games:", nrow(ytd_data), "rows\n\n")
    
    if (nrow(ytd_data) > 0) {
      # Aggregate by player
      ytd_new_data <- ytd_data %>%
        group_by(Player) %>%
        summarise(
          Games_new = n(),
          Total_Expected_Skins_new = sum(Expected_Skins, na.rm = TRUE),
          Total_Actual_Skins_new = sum(Actual_Skins, na.rm = TRUE),
          Cumulative_Skins_Luck_new = sum(Skins_Luck, na.rm = TRUE),
          .groups = 'drop'
        )
      
      cat("New data aggregated by player:\n")
      print(kable(ytd_new_data, caption = "Aggregated new data (from valid CSV files)"))
      
      # Now combine with baseline
      if (exists("ytd_baseline")) {
        ytd_baseline_renamed <- ytd_baseline %>%
          rename(
            Games_baseline = Games,
            Total_Expected_Skins_baseline = Total_Expected_Skins,
            Total_Actual_Skins_baseline = Total_Actual_Skins,
            Cumulative_Skins_Luck_baseline = Cumulative_Skins_Luck
          )
        
        ytd_summary <- ytd_baseline_renamed %>%
          full_join(ytd_new_data, by = "Player") %>%
          mutate(
            Games = coalesce(Games_baseline, 0) + coalesce(Games_new, 0),
            Total_Expected_Skins = coalesce(Total_Expected_Skins_baseline, 0) + coalesce(Total_Expected_Skins_new, 0),
            Total_Actual_Skins = coalesce(Total_Actual_Skins_baseline, 0) + coalesce(Total_Actual_Skins_new, 0),
            Cumulative_Skins_Luck = coalesce(Cumulative_Skins_Luck_baseline, 0) + coalesce(Cumulative_Skins_Luck_new, 0)
          ) %>%
          select(Player, Games, Total_Expected_Skins, Total_Actual_Skins, Cumulative_Skins_Luck)
        
        cat("\n\nFinal YTD Summary (baseline + new data):\n")
        print(kable(ytd_summary, caption = "Final calculated YTD stats"))
      }
    } else {
      cat("ERROR: No data found after filtering!\n")
    }
  } else {
    cat("ERROR: No valid files found!\n")
  }
} else {
  cat("ERROR: Cannot aggregate - missing baseline_date or no CSV files\n")
}
```

---

## 7. Chart Data Construction Test

```{r chart_data_test}
#| echo: false
cat("=== TESTING CHART DATA CONSTRUCTION ===\n\n")

if (!is.na(baseline_date) && exists("ytd_baseline")) {
  baseline_chart_date <- baseline_date - days(1)
  cat("Baseline chart date:", as.character(baseline_chart_date), "\n\n")
  
  baseline_start <- ytd_baseline %>%
    mutate(
      Date = baseline_chart_date,
      Daily_Expected = Total_Expected_Skins,
      Daily_Actual = Total_Actual_Skins,
      Daily_Luck = Cumulative_Skins_Luck
    ) %>%
    select(Player, Date, Daily_Expected, Daily_Actual, Daily_Luck)
  
  cat("Baseline starting point:\n")
  print(kable(baseline_start, caption = "Baseline data for chart"))
  
  # Check if we have new daily data
  if (exists("ytd_data") && nrow(ytd_data) > 0) {
    daily_data_summarized <- ytd_data %>%
      group_by(Player, Date) %>%
      summarise(
        Daily_Expected = sum(Expected_Skins, na.rm = TRUE),
        Daily_Actual = sum(Actual_Skins, na.rm = TRUE),
        Daily_Luck = sum(Skins_Luck, na.rm = TRUE),
        .groups = 'drop'
      )
    
    cat("\n\nDaily data summarized:\n")
    print(kable(daily_data_summarized, caption = "New daily data"))
    
    # Combine baseline with new data
    chart_data <- bind_rows(baseline_start, daily_data_summarized) %>%
      arrange(Player, Date) %>%
      group_by(Player) %>%
      mutate(
        Cumulative_Expected = cumsum(Daily_Expected),
        Cumulative_Actual = cumsum(Daily_Actual),
        Cumulative_Luck = cumsum(Daily_Luck)
      ) %>%
      ungroup()
    
    cat("\n\nFinal chart data (with cumulative calculations):\n")
    print(kable(chart_data, caption = "Final chart data"))
    
    cat("\n\nPlayers in chart data:", paste(unique(chart_data$Player), collapse = ", "), "\n")
    cat("Date range:", as.character(min(chart_data$Date)), "to", as.character(max(chart_data$Date)), "\n")
  } else {
    cat("\n\nNo new data yet - chart would use baseline only\n")
  }
} else {
  cat("ERROR: Cannot construct chart data - missing baseline_date or ytd_baseline\n")
}
```

---

## 8. Root Cause Analysis

```{r root_cause}
#| echo: false
#| results: 'asis'
cat("## ROOT CAUSE SUMMARY\n\n")

issues_found <- character(0)

# Check baseline_date
if (!file.exists(baseline_date_file)) {
  issues_found <- c(issues_found, "❌ baseline_date.txt file does not exist")
} else if (is.na(baseline_date)) {
  issues_found <- c(issues_found, "❌ baseline_date.txt contains invalid date")
} else {
  cat("✅ baseline_date.txt exists and contains valid date:", as.character(baseline_date), "\n\n")
  
  # Check if baseline date is too recent
  if (baseline_date >= today_ct) {
    issues_found <- c(issues_found, paste("❌ baseline_date is today or in the future:", as.character(baseline_date)))
  }
}

# Check ytd_baseline.csv
if (!file.exists(historical_file)) {
  issues_found <- c(issues_found, "❌ ytd_baseline.csv file does not exist")
} else {
  cat("✅ ytd_baseline.csv exists\n\n")
}

# Check for CSV files
if (length(all_files) == 0) {
  issues_found <- c(issues_found, "❌ No historical CSV files found in skins_history/")
} else {
  cat("✅ Found", length(all_files), "historical CSV files\n\n")
}

# Check if valid files exist
if (exists("valid_files") && length(valid_files) == 0) {
  issues_found <- c(issues_found, "❌ No CSV files pass the baseline_date filter")
} else if (exists("valid_files")) {
  cat("✅", length(valid_files), "files pass the baseline_date filter\n\n")
}

# Check if ytd_data has rows
if (exists("ytd_data") && nrow(ytd_data) == 0) {
  issues_found <- c(issues_found, "❌ No completed games found in filtered data (ytd_data is empty)")
} else if (exists("ytd_data")) {
  cat("✅ ytd_data contains", nrow(ytd_data), "completed games\n\n")
}

if (length(issues_found) > 0) {
  cat("\n### Issues Found:\n\n")
  for (issue in issues_found) {
    cat(issue, "\n")
  }
} else {
  cat("### ✅ No obvious issues found - system should be working correctly\n")
}
```

---

## 9. Expected Data for Nov 2

Based on the user's provided data, the YTD table as of Nov 2 (BEFORE today's games) should show:

```{r expected_nov2}
#| echo: false
expected_nov2 <- data.frame(
  Player = c("Adam", "Eristeo", "Kenneth", "Brian", "Thomas", "Matt"),
  Games = c(29, 27, 31, 30, 28, 27),
  Total_Expected_Skins = c(18.1, 19.8, 18.9, 18.5, 18.4, 20.1),
  Total_Actual_Skins = c(17, 20, 15, 21, 12, 20),
  Cumulative_Skins_Luck = c(-1.1, 0.2, -3.9, 2.5, -6.4, -0.1),
  Avg_Skins_Luck_per_Game = c(-0.04, 0.01, -0.13, 0.08, -0.23, 0.00)
)

print(kable(expected_nov2, digits = 2, caption = "Expected YTD Stats as of Nov 2 (before today's games)"))

cat("\n\nThis represents:\n")
cat("- Baseline (Oct 24-30): Original ytd_baseline.csv\n")
cat("- Oct 31 games: From 2025-10-31.csv\n")
cat("- Nov 1 games: From 2025-11-01.csv\n")
cat("- Nov 2 games: NOT YET INCLUDED (games still in progress)\n")
```

---

## 10. Recommendations

```{r recommendations}
#| echo: false
#| results: 'asis'
cat("### Recommended Actions:\n\n")

if (!is.na(baseline_date) && baseline_date >= as_date("2025-11-02")) {
  cat("1. **CRITICAL:** Reset baseline_date.txt to 2025-11-01\n")
  cat("   - This will include Nov 1 and Nov 2 data in the YTD calculations\n\n")
}

if (exists("ytd_baseline")) {
  cat("2. **UPDATE ytd_baseline.csv** with the Nov 2 baseline data provided by user:\n")
  cat("   - This ensures the baseline includes Oct 24-Nov 1 data\n\n")
}

cat("3. **Verify CSV files exist:**\n")
cat("   - 2025-10-31.csv should exist with 16 rows\n")
cat("   - 2025-11-01.csv should exist with 12 rows\n")
cat("   - 2025-11-02.csv should exist with 16 rows (will be updated as games finish)\n\n")

cat("4. **Chart issue:** If Brian won a skin today but doesn't appear in chart:\n")
cat("   - Check that 2025-11-02.csv has Brian's completed game with Actual_Skins = 1\n")
cat("   - Verify the daily_data_summarized includes Brian\n")
cat("   - Check that chart_data includes all players with completed games\n\n")

if (exists("ytd_data") && nrow(ytd_data) == 0) {
  cat("5. **If ytd_data is empty:** The issue is with filtering logic\n")
  cat("   - Check that baseline_date is correct\n")
  cat("   - Verify CSV files have Won_Game and Actual_Skins populated\n")
  cat("   - Confirm filter: year(Date) == current_year, !is.na(Actual_Skins)\n\n")
}
```

---

## 11. Quick Fix: Hardcode Baseline

If the diagnostic shows the system will work going forward, here's the hardcoded baseline to use:

```{r hardcoded_baseline}
#| echo: false
cat("```r\n")
cat("# Updated baseline data as of Nov 2 (includes Oct 24-Nov 1)\n")
cat("ytd_baseline <- tribble(\n")
cat("  ~Player, ~Games, ~Total_Expected_Skins, ~Total_Actual_Skins, ~Cumulative_Skins_Luck,\n")
cat('  "Adam", 29, 18.1, 17, -1.1,\n')
cat('  "Eristeo", 27, 19.8, 20, 0.2,\n')
cat('  "Kenneth", 31, 18.9, 15, -3.9,\n')
cat('  "Brian", 30, 18.5, 21, 2.5,\n')
cat('  "Thomas", 28, 18.4, 12, -6.4,\n')
cat('  "Matt", 27, 20.1, 20, -0.1\n')
cat(")\n")
cat("```\n")
```

And set baseline_date.txt to: **2025-11-02**

This way:
- The baseline includes all data through Nov 1
- New data from Nov 2 onward will be added on top
- Today's completed games will show in both table and chart
