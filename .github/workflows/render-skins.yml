name: Render and Publish Skins Page

on:
  # Schedule to run at 13:00 UTC (7:00 AM CST / 8:00 AM CDT)
  schedule:
    - cron: '0 12 * * *'  # 6am Central (12:00 UTC)
    - cron: '0 14 * * *'  # 8am Central (14:00 UTC)
    - cron: '0 18 * * *'  # Noon Central (18:00 UTC)
    - cron: '0 22 * * *'  # 4pm Central (22:00 UTC)
    - cron: '0 2 * * *'   # 8pm Central (02:00 UTC next day)
    - cron: '0 3 * * *'   # 9pm Central (03:00 UTC next day)
    - cron: '0 4 * * *'   # 10pm Central (04:00 UTC next day)
    - cron: '0 5 * * *'   # 11pm Central (05:00 UTC next day)
    - cron: '0 6 * * *'   # Midnight Central (06:00 UTC next day)
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Set permissions for the job
permissions:
  contents: write  # Changed from 'read' to 'write' to commit history
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper commits
      
      # Install system libraries required by rvest/xml2
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libcurl4-openssl-dev \
            libxml2-dev \
            libssl-dev \
            libfontconfig1-dev \
            libfreetype6-dev \
            libfribidi-dev \
            libharfbuzz-dev \
            libpng-dev
      
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'latest'
      
      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2
      
      # Install R packages (added readr)
      - name: Install R Dependencies
        run: |
          R -e "install.packages('pacman', dependencies = TRUE)"
          R -e "pacman::p_load(rvest, httr, dplyr, tidyr, stringr, lubridate, tibble, knitr, kableExtra, readr)"
      
      # Create history directory if it doesn't exist
      - name: Create history directory
        run: |
          mkdir -p skins_history
      
      # Render the document (update filename to match your new file)
      - name: Render Quarto Document
        run: |
          quarto render nba_skins_with_history.qmd --to html --output-dir _site --output index.html
      
      # Commit the updated history back to the repository
      - name: Commit history updates
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add skins_history/*.csv
          git diff --staged --quiet || git commit -m "Update skins history - $(date +'%Y-%m-%d')"
          git push
        continue-on-error: true  # Don't fail if there are no changes to commit
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './_site'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
